{{ define "main" }}
<section class="hero hero-small">
  <div class="container">
    <p class="tagline">Let's Explore</p>
    <h1 class="main-heading">{{ .Title }}</h1>
  </div>
</section>

<section class="section topic-content-wrapper">
    <!-- Progress Ring Floater (absolute in main section) -->
    <div class="progress-ring-floating">
      <svg class="ring" width="60" height="60">
        <circle class="bg" cx="30" cy="30" r="25"></circle>
        <circle class="progress" cx="30" cy="30" r="25"></circle>
      </svg>
      <div class="progress-text">0%</div>
    </div>

    <div class="topic-outline">
      <h2>We will be covering:</h2>
      <ul>
        {{ $content := .Content }}
        {{ $matches := findRE "<h2[^>]*>(.*?)</h2>" $content }}
        {{ range $i, $match := $matches }}
        <li>{{ replaceRE "<.*?>" "" $match }}</li>
        {{ end }}
      </ul>
    </div>
  
    <div class="container">
      <div class="topic-meta">
        <p class="last-updated">
          {{ if .GitInfo }}
            Last updated on: {{ .GitInfo.AuthorDate.Format "2 Jan, 2006" }}
          {{ else }}
            Last updated on: {{ .Lastmod.Format "2 Jan, 2006" }}
          {{ end }}
        </p>
      </div>
    </div>

    <article class="topic-content">
      {{ .Content }}
    </article>
  </div>
</section>

<section class="topic-nav">
  <div class="container nav-buttons">
    {{ with .NextInSection }}
      <a href="{{ .RelPermalink }}" class="btn nav-btn">&larr; Back</a>
    {{ end }}

    {{ partial "find-top-section.html" . }}
    {{ $top := .Scratch.Get "topPageObject" }}
    {{ with $top }}
    <a href="{{ .RelPermalink }}" class="btn nav-btn">
        {{ .Title }} : Home Page
    </a>
    {{ end }}

    {{ with .PrevInSection}}
      <a href="{{ .RelPermalink }}" class="btn nav-btn">Next &rarr;</a>
    {{ end }}
  </div>
</section>

<!-- JS for Progress Ring -->
<script>
  document.addEventListener("scroll", function () {
    const scrollTop = window.scrollY;
    const docHeight = document.body.scrollHeight - window.innerHeight;
    const scrollPercent = Math.min((scrollTop / docHeight) * 100, 100);

    const circle = document.querySelector(".progress-ring-floating .progress");
    const text = document.querySelector(".progress-ring-floating .progress-text");

    const radius = 25;
    const circumference = 2 * Math.PI * radius;
    const offset = circumference - (scrollPercent / 100) * circumference;

    circle.style.strokeDashoffset = offset;
    text.textContent = Math.round(scrollPercent) + "%";
  });
</script>

<script>
(() => {
  const NAV_HEIGHT = 60; // match your CSS top (e.g., h2 { top: 150px })
  const headings = document.querySelectorAll(".topic-content h2");

  headings.forEach(h => {
    // Create a sentinel just before the heading in normal flow
    const sentinel = document.createElement("div");
    sentinel.className = "sticky-sentinel";
    sentinel.style.height = "1px";

    h.parentNode.insertBefore(sentinel, h);

    const observer = new IntersectionObserver(
      ([entry]) => {
        // When sentinel goes above the sticky line, heading is stuck
        h.classList.toggle("is-stuck", !entry.isIntersecting);
      },
      {
        root: null,
        threshold: 0,
        // Move the "top" of the observer down by NAV_HEIGHT
        // So "not intersecting" means sentinel is above that line.
        rootMargin: `-${NAV_HEIGHT}px 0px 0px 0px`
      }
    );

    observer.observe(sentinel);
  });
})();
</script>
{{ end }}